<!DOCTYPE HTML>
<html>
<head>
    <title>Title III Utah</title>
    <!--<script src="http://d3js.org/d3.v3.min.js"></script>-->
    <script type="text/javascript" src="{{url_for('static', filename='d3.v3.min.js')}}"></script>
    <!--<script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.min.js"></script>-->
    <script type="text/javascript" src="{{url_for('static', filename='d3.tip.min.js')}}"></script>
    <script type="text/javascript" src="{{url_for('static', filename='trackinghelper.js')}}"></script>
    <script src="http://dimplejs.org/dist/dimple.v1.min.js"></script>
    <link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css">
    <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
    <script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
    <div style = "float: left; position:relative;width:100%;height: 10px"></div>
    <div style = "float: left; position:relative;width:100%;background: black;height: 5px"></div>
    <div style = "float: left; position:relative;width:100%;background: black;height: 25px; font-family: arial,helvetica,sans-serif; color: white; font-size: 20px; text-indent: 100px;">Title III Tracking - State of Utah<a href='/logout' style="font-family: roboto; font-size: 10px;color: white; float:right; margin: 5px 10px 0px 0px">logout</a></div>
    <div style = "float: left; position:relative;width:100%;background: black;height: 5px"></div>
    <div style = "float: left; position:relative;width:100%;background: white;height: 25px"/></div>
</head>
<style>
.d3-tip {
  line-height: 1;
  font-family: arial,helvetica,sans-serif;
  font-weight: bold;
  padding: 12px;
  background: rgba(0, 0, 0, 0.8);
  color: #fff;
  border-radius: 2px;
}
# districtText {
    color: grey;
}
# listen .fontChg {font-family: Roboto};
</style>

<div id="listen"></div>
<div id="speak"></div>
<div id="read"></div>
<div id="write"></div>

<script type="text/javascript">
        
// map area variables
var h = 550, w = 600, centered,active,zoomed = false,myDistrict = null;

var projection = d3.geo.mercator()
    .scale(1)
    .translate([0,0]);

var path = d3.geo.path()
    .projection(projection);

var textFilters = d3.select("body").append("svg")
    .style("margin","0px 0px 0px 25px")
    .style("float","left")
    .attr("width",w)
    .attr("height",50);

var canvas = d3.select("body").append("svg")
    .style("margin","0px 0px 0px 25px")
    .style("float","left")
    .style("clear","left")
    .attr("width",w)
    .attr("height",h);

// table/chart area variables
var tblw = 830, tblh = 600
var tcanvas = d3.select("body").append("svg")
    .style("float","left")
    .style("margin","-50px 0 0 20px")
    .attr("transform","translate(0,0)")
    .attr("width",tblw)
    .attr("height",tblh)

// var tFrame = tcanvas.append("rect")
//     .attr("width",tblw)
//     .attr("height",tblh)
//     .attr("stroke","grey")
//     .attr("fill","none")
//

var gframe = tcanvas.append("g")

var colorScale = d3.scale.linear().domain([0,4]).range(["black","lime"]);


// READ IN THE JSON DATA FOR THE MAP
d3.json("{{url_for('static', filename='utah.json')}}", function(data){              

    //////// Chart A moving to destination 1 ////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    var aData = filter(data.features)

    ax = tblw*.05//20//w * aMargins // indent in by margin % of width
    ay = tblh*.05//20//h * aMargins // indent in by margin % of height
    aw = tblw*(.9)//690//w - (2*aMargins*w) // half the width of the main canvas
    ah = tblh*.9//550//h - (2*aMargins*h)  // half the height of the main canvas

    // remember that when you scale the object each unit in the coordinate space scales at the same rate SO ADJUST
    asx = (tblw/3) / tblw
    atx = -ax * asx // adjusting for the scale plus
    aty = -ay * asx // adjusting for the scale plus

    aSvg = tcanvas.append("svg")
                .attr("x",ax)
                .attr("y",ay)    
                .attr("width",aw)
                .attr("height",ah)
                .attr("class","zoomedOut")
/*                .on("click",function(d){
                                        transformIt(d3.select(this),a_1transx,a_1transy,a_1scale,a_1scale);
                                        appearance("b1Chrt",b1svg,b1data,"K - 6","line");
                                        appearance("b2Chrt",b2svg,b2data,"7 - 12","line");
                                    })*/

    drawTblA(aSvg,aData,ah,aw)

    //////// Chart B1 moving to destination 2 ///////////////////////////////////////////////////////////////////////////////////////////////////////////////

    var b1x = 0
    var b1y = tblh * .45
    var b1w = tblw * .5  
    var b1h = tblh * .55

    // remember that when you scale the object each unit in the coordinate space scales at the same rate SO ADJUST
    var b1_2scaleX = (tblw/3) / b1w 
    var b1_2scaleY = b1y / b1h
    var b1_2transX = tblw/3
    var b1_2transY = -b1y *  b1_2scaleX // just use the same scale as X so the proportions looks the same

    b1svg = tcanvas.append("svg")
                .attr("x",b1x)
                .attr("y",b1y)
                .attr("width",b1w)
                .attr("height",b1h)
                .classed("zoomedOut",true)
                .classed("notAppearing",true)
                .on("click",function(d){
                                        transformIt(d3.select(this),b1_2transX,b1_2transY,b1_2scaleX,b1_2scaleX);
                                        appearance("b2Chrt",b2svg,b2data,"7 - 12","line");
                                        appearance("cChrt",csvg,cdata,"Performance By Grade","bar");
                                    })

    b1data = [
        {"Type":"Actual","Year":2012,"Score":.20},
        {"Type":"Actual","Year":2013,"Score":.30},
        {"Type":"Actual","Year":2014,"Score":.50},
        {"Type":"Benchmark","Year":2012,"Score":.25},
        {"Type":"Benchmark","Year":2013,"Score":.32},
        {"Type":"Benchmark","Year":2014,"Score":.45}
    ];


    //////// Chart B2 moving to destination 2 ////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    var b2x = tblw * .5
    var b2y = tblh * .45
    var b2w = tblw * .5  
    var b2h = tblh * .55

    // remember that when you scale the object each unit in the coordinate space scales at the same rate SO ADJUST
    var b2_2scaleX = (tblw/3)/ b2w 
    var b2_2scaleY = b2y/b2h
    var b2_2transX = 0
    var b2_2transY = -b2y * b2_2scaleX // adjusting for the scale plus give a little buffer

    b2svg = tcanvas.append("svg")
                .attr("x",b2x)
                .attr("y",b2y)
                .attr("width",b2w)
                .attr("height",b2h)
                .classed("zoomedOut",true)
                .classed("notAppearing",true)
                .attr("fill-opacity","1")
                //.on("click",function(d){transformIt(d3.select(this),b2_2transX,b2_2transY,b2_2scaleX,b2_2scaleX); appearance(b1Chrt,cChrt);})
                .on("click",function(d){
                                        transformIt(d3.select(this),b2_2transX,b2_2transY,b2_2scaleX,b2_2scaleX);
                                        appearance("b1Chrt",b1svg,b1data,"K - 6","line");
                                        appearance("cChrt",csvg,cdata,"Performance By Grade","bar");
                                    })

    b2data = [
        {"Type":"Actual","Year":2012,"Score":.25},
        {"Type":"Actual","Year":2013,"Score":.32},
        {"Type":"Actual","Year":2014,"Score":.38},
        {"Type":"Benchmark","Year":2012,"Score":.26},
        {"Type":"Benchmark","Year":2013,"Score":.33},
        {"Type":"Benchmark","Year":2014,"Score":.47}
    ];

    //////// Chart C moving to destination 3 ///////////////////////////////////////////////////////////////////////////////////////////////////////////////

    var cx = tblw / (3 * 2)
    var cy = tblh * .45
    var cw = tblw / 3 * 2 
    var ch = tblh * .55

    // remember that when you scale the object each unit in the coordinate space scales at the same rate SO ADJUST
    var c3scale = (tblw/3) / cw 
    var c3transx = tblw/3 + 185// ( bscale * .95 ) // adjusting for the scale plus give a little buffer
    var c3transy = -cy * c3scale + 15 // adjusting for the scale plus give a little buffer

    csvg = tcanvas.append("svg")
                .attr("x",cx)
                .attr("y",cy)
                .attr("width",cw)
                .attr("height",ch)
                .classed("zoomedOut",true)
                .classed("notAppearing",true)
                .on("click",function(d){
                                        transformIt(d3.select(this),c3transx,c3transy,c3scale,c3scale);
                                        tblAppearance(dsvg,dData);
                                    })

    cdata = [
        {"Grade":"K","Score":.20},
        {"Grade":"1","Score":.30},
        {"Grade":"2","Score":.50},
        {"Grade":"3","Score":.25},
        {"Grade":"4","Score":.32},
        {"Grade":"5","Score":.45},
        {"Grade":"6","Score":.43},
    ];

    //////// Table D appearing ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

    var dx = 0
    var dy = tblh * .45
    var dw = tblw
    var dh = tblh * .55

    dsvg = tcanvas.append("svg")
                .attr("x",dx)
                .attr("y",dy)
                .attr("width",dw)
                .attr("height",dh)
                .classed("notAppearing",true)

    dData = [
        ["Teacher","Students","PASS","L","S","R","W"],
        ["Mr. Gonzalez",12,.5,.3,.35,.75,.70],
        ["Mr. Johnson",10,.55,.32,.33,.78,.71],
        ["Mrs. Hochauser",13,.45,.5,.25,.25,.75],
        ["Mrs. Fuentes",15,.65,.55,.55,.75,.75]
    ];

    ///////////////////////////////////////////////////////
    ////////////////////  MAP STUFF  //////////////////////
    ///////////////////////////////////////////////////////

    // auto scaling
    var b = path.bounds(data),
        s = .95 / Math.max((b[1][0] - b[0][0]) / w, (b[1][1] - b[0][1]) / h),
        t = [(w - s * (b[1][0] + b[0][0])) / 2, (h - s * (b[1][1] + b[0][1])) / 2];

    projection
        .scale(s)
        .translate(t);

    // tooltip
    var tip = d3.tip()
      .attr('class', 'd3-tip')
      .offset([-10, 0])
      .html(function(d) {
        return "<strong>" + d.properties.NAME + "</strong><br>Students: " + d.properties.students;
      });

    // create group elements for the district paths
    var group = canvas.selectAll("g")
        .data(data.features)
        .enter()
        .append("g")
    
    group.call(tip);

    // throw district paths into each group element
    var areas = group.append("path")
        .attr("d",path)
        .attr("fill",function(d){return colorScale(d.properties["2014"]["K-12"]["passed"]);})
        //.attr("class","feature")
        .attr("stroke","white")
        .attr("stroke-width",1)
        .attr("fill-opacity",1)
        .on("click",clicked)
        .on("mouseover",function(){d3.select(this).attr("fill-opacity",".85")})
        .on("mouseout",function(){d3.select(this).attr("fill-opacity","1")})
        //.on("mouseout",areas.classed("hover",false))
        .on("mouseover.tooltip",tip.show)
        .on("mouseout.tooltip",tip.hide)


    // map frame
    var box = canvas.append("rect")
        .attr("width",w)
        .attr("height",h)
        .attr("fill","none")
        .attr("stroke","lightgrey")
        //.style("margin",100);

    ///////////////////////////////////////////////////////
    //////////////////  FILTERS STUFF /////////////////////
    ///////////////////////////////////////////////////////
    
    var textText = textFilters.append("text")
        .attr("y",20)
        .text("District Selected: All Districts")
        .style("font-family","Roboto")
        .style("font-size","20px")

    //////////////////////////////////////
    /////////////// ACTIONS //////////////
    //////////////////////////////////////

    // click to center and zoom
    function clicked(d){
        var x, y, k;

        if(d && centered !== d){
            var bnd = path.bounds(d);
            var centroid = path.centroid(d);
            k = .85 / Math.max((bnd[1][0]-bnd[0][0])/w,(bnd[1][1]-bnd[0][1])/h);
            x = -centroid[0] + w/(k*2);
            y = -centroid[1] + h/(k*2);
            centered = d;
        }
        else {
            x = 0;
            y = 0;
            k = 1;
            centered = null;
        }

        if(centered === d){
            var aData = filter(data.features,d.properties.NAME)
            //drawTblA(dset,d.properties.NAME)
            drawTblA(aSvg,aData,ah,aw)
            myDistrict = d.properties.NAME
        }
        else{
            var aData = filter(data.features)
            drawTblA(aSvg,aData,ah,aw)
            myDistrict = 'All Districts'
        }

        areas.transition()
            .duration(700)
            .attr("transform", "scale(" + k + ")translate(" + x + "," + y + ")")
            .attr("stroke-width",1/k + "px");

        textText.text("District Selected: "+myDistrict)

    }

    function genChrtData(year,amo,json,district){

        var generatedChrtData = []

        // if no district then set up 3 arrays 1 for each year and toss in each AMAO 
        if (district) {
            for (i = 0; i < json.length; i++) {
                if (json[i]["properties"]["NAME"] === district) {

                    // add each of the scores to each array
                    generatedChrtData.push(json[i]["properties"][year]["K-6"][amo])
                    generatedChrtData.push(json[i]["properties"][year]["7-12"][amo])
                }
            }
        }
        else {
            generatedChrtData.push(.33)
            generatedChrtData.push(.56)
        }
        console.log(generatedChrtData)
        return generatedChrtData
    }

    function animate(d,i,j){

        if (i === 1) {var year = "2012"}
        if (i === 2) {var year = "2013"}
        if (i === 3) {var year = "2014"}

        if (j === 1) {var amao = "AMAO #1"}
        if (j === 2) {var amao = "AMAO #2"}
        if (j === 3) {var amao = "AMAO #3"}


        if (zoomed === false) {

            if (myDistrict === null){drawChrt(genChrtData(year,amao,data.features))}
            else {drawChrt(genChrtData(year,amao,data.features,myDistrict))}
            
            gframe.transition().duration(700).attr("transform","translate(0,-30)scale(.60)")
            zoomed = true
            rectangles.transition().duration(300).delay(200).attr("fill-opacity","1")
            target.transition().duration(300).delay(400).attr("stroke-opacity","1")
            target2.transition().duration(300).delay(400).attr("stroke-opacity","1")
            k6.transition().duration(300).delay(400).style("opacity","1")
            sevn12.transition().duration(300).delay(400).style("opacity","1")
            c1l1.transition().duration(300).delay(400).attr("stroke-opacity","1").attr("fill-opacity","1")
            c2l1.transition().duration(300).delay(400).attr("stroke-opacity","1").attr("fill-opacity","1")
            c1l2.transition().duration(300).delay(400).attr("stroke-opacity","1").attr("fill-opacity","1")
            c2l2.transition().duration(300).delay(400).attr("stroke-opacity","1").attr("fill-opacity","1")


        } 
        else {

            if (myDistrict === null){drawChrt(genChrtData(year,amao,data.features))}
            else {drawChrt(genChrtData(year,amao,data.features,myDistrict))}

            gframe.transition().duration(700).attr("transform","translate(0,0)scale(1)")
            rectangles.attr("fill-opacity","0")
            target.attr("stroke-opacity","0")
            target2.attr("stroke-opacity","0")
            k6.style("opacity","0")
            sevn12.style("opacity","0")
            c1l1.attr("stroke-opacity","0").attr("fill-opacity","0")
            c2l1.attr("stroke-opacity","0").attr("fill-opacity","0")
            c1l2.attr("stroke-opacity","0").attr("fill-opacity","0")
            c2l2.attr("stroke-opacity","0").attr("fill-opacity","0")
            zoomed = false

        };
    };
});

    </script>
</body>
</html>